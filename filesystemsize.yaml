---
- name: Check root filesystem usage
  hosts: all
  become: true
  vars:
    filesystem: "/"

  tasks:
    - name: set Filesystem usage fact
      ansible.builtin.set_fact:
        root_path: "{{( ansible_facts.mounts | selectattr('mount', 'in', path))[-1] }}"
  
    - name: delete files if root filesystem is more than 80% full
      when: ansible_mounts['/']['size_available'] / ansible_mounts['/']['size_total'] < "20"
      block:
       - name: Categorize filesystem usage
         ansible.builtin.debug:
           msg: >
             Root filesystem usage is ({{ root_fs_usage }}%) utilized

       - name: Analyzing the directories to delete...
         ansible.builtin.find:
           paths: /tmp
           patterns: "*.file"
           age: 5
           age_stamp: atime
         register: files_to_delete

       - name: Displaying the result...
         ansible.builtin.debug:
           var: files_to_delete.files

       - name: Deleting the files...
         ansible.builtin.file:
           path: "{{ item.path }}"
           state: absent
         with_items: "{{ files_to_delete.files }}"
